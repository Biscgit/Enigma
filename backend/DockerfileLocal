# by David HorvÃ¡t, 2024
FROM python:3.12-alpine AS builder

RUN apk update && apk add --no-cache curl gcc musl-dev
RUN curl --proto '=https' --tlsv1.3 -sSf https://sh.rustup.rs > rustup.sh && \
    chmod +x rustup.sh && \
    ./rustup.sh -y && \
    rm rustup.sh
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup default stable

# setup python
RUN python3 -m ensurepip
RUN python3 -m pip install --no-cache --upgrade pip setuptools maturin

# install rustlib
ENV PYO3_PYTHON=python3.12
WORKDIR /home/

COPY ./rustlib .
RUN python3 -m maturin build --release --strip --color never -o wheel && cargo clean

FROM python:3.12-alpine

# permission security
RUN addgroup -S sgroup && adduser -S fastapi -G sgroup
WORKDIR /home/fastapi

# install dependencies
RUN apk update && apk upgrade && apk add --no-cache gcc

COPY requirements.txt ./
RUN python3 -m pip install --no-cache-dir -r requirements.txt

# install rustlib
COPY --from=builder /home/wheel/rustlib-0.1.0-cp312-cp312-linux_x86_64.whl ./packeges/
RUN python3 -m pip install --no-cache-dir ./packeges/*.whl && rm -r ./packeges

# copy files and run
USER fastapi
WORKDIR /home/fastapi
COPY ./server ./server

EXPOSE 8001
ENTRYPOINT ["uvicorn", "server.app:app", "--host", "0.0.0.0", "--port", "8001"]
