# by David HorvÃ¡t, 2024
FROM debian:stable-slim as builder

# install dependencies
RUN apt update
RUN apt install -y curl file git unzip xz-utils zip libglu1-mesa clang cmake ninja-build pkg-config libgtk-3-dev sudo

# permissions
RUN useradd -ms /bin/bash builder
RUN echo 'builder ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER builder
WORKDIR /home/builder

# install flutter
RUN curl -O https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.22.2-stable.tar.xz &&  \
    tar xf flutter_linux_*-stable.tar.xz --directory=/home/builder/ && \
    rm flutter_linux_*-stable.tar.xz
ENV PATH="${PATH}:/home/builder/flutter/bin"

# configure flutter
RUN git config --global --add safe.directory /home/builder/flutter
RUN flutter --disable-analytics && flutter config --no-cli-animations
RUN flutter channel stable && flutter upgrade

# generate build folder
WORKDIR /home/builder/frontend
RUN flutter create --platforms web .
RUN flutter clean

# setup
USER builder
WORKDIR /home/builder/frontend

# copy files and build
COPY ./pubspec.yaml .
RUN flutter pub get
COPY . .
RUN flutter build web --release

# serve site with nginx
FROM nginx:mainline-alpine-slim
RUN apk update && apk upgrade

# copy files
WORKDIR /home/webserver
COPY --from=builder /home/builder/frontend/build/web /home/webserver/enigma
COPY ./nginx.conf /etc/nginx/

# expose and run
EXPOSE 8080
